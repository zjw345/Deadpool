name: Manual Go Build and Release

on:
  workflow_dispatch:  # 手动触发
    inputs:
      version:
        description: '请输入版本号 (如 v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [linux, windows]
        arch: [amd64, arm64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        # 获取所有分支
        fetch-depth: 0

    - name: Get all branches
      run: echo "BRANCHES=$(git branch -r | grep -v '\->' | sed 's/origin\///' | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Loop through branches and build
      run: |
        for BRANCH in $BRANCHES; do
          echo "Building branch: $BRANCH"
          git checkout $BRANCH
          
          # 创建发布目录
          mkdir -p ./release-artifacts/$BRANCH
          
          for OS in linux windows; do
            for ARCH in amd64 arm64; do
              echo "Building for OS: $OS, ARCH: $ARCH"
              OUTPUT=myapp-${BRANCH}-${OS}-${ARCH}${{ matrix.os == 'windows' && '.exe' || '' }}
              GOOS=$OS GOARCH=$ARCH go build -o $OUTPUT .
              
              # 打包
              tar -czf myapp-${BRANCH}-${OS}-${ARCH}.tar.gz $OUTPUT
              mv myapp-${BRANCH}-${OS}-${ARCH}.tar.gz ./release-artifacts/$BRANCH/
            done
          done
        done

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./release-artifacts/**/*  # 上传所有分支的压缩包
        tag_name: ${{ inputs.version }}  # 使用输入的版本号作为标签
        release_name: ${{ inputs.version }}  # 使用输入的版本号作为发布名称
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
